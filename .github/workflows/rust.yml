name: Rust CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
    paths:
      - 'chatguru-clickup-middleware/**'
      - '.github/workflows/**'
      - 'cloudbuild.yaml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'chatguru-clickup-middleware/**'
      - '.github/workflows/**'

env:
  CARGO_TERM_COLOR: always
  GCP_PROJECT: buzzlightear
  GCP_REGION: southamerica-east1
  SERVICE_NAME: chatguru-clickup-middleware
  CONFIG_BUCKET: chatguru-middleware-config

jobs:
  # Job 1: Build e testes locais
  test:
    name: Test and Validate
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        components: rustfmt, clippy
        override: true
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check formatting
      working-directory: ./chatguru-clickup-middleware
      run: cargo fmt --all -- --check
    
    - name: Run clippy
      working-directory: ./chatguru-clickup-middleware
      run: cargo clippy --all-targets --all-features -- -D warnings
    
    - name: Build
      working-directory: ./chatguru-clickup-middleware
      run: cargo build --verbose
    
    - name: Run tests
      working-directory: ./chatguru-clickup-middleware
      run: cargo test --verbose

  # Job 2: Sincronizar configurações com GCS (apenas na main)
  sync-configs:
    name: Sync Configs to GCS
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.GCP_PROJECT }}
    
    - name: Sync config files to GCS
      run: |
        echo "Syncing configuration files to gs://${{ env.CONFIG_BUCKET }}/"
        gsutil -m rsync -r -d \
          -x ".*\.toml\.example$" \
          chatguru-clickup-middleware/config/ \
          gs://${{ env.CONFIG_BUCKET }}/
        
        # Create backup with timestamp
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        echo "Creating backup at gs://${{ env.CONFIG_BUCKET }}/backups/${TIMESTAMP}/"
        gsutil -m cp -r \
          chatguru-clickup-middleware/config/*.toml \
          chatguru-clickup-middleware/config/*.yaml \
          gs://${{ env.CONFIG_BUCKET }}/backups/${TIMESTAMP}/ 2>/dev/null || true

  # Job 3: Trigger Cloud Build (apenas na main)
  trigger-cloud-build:
    name: Trigger GCP Cloud Build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [test, sync-configs]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.GCP_PROJECT }}
    
    - name: Trigger Cloud Build
      run: |
        echo "Triggering Cloud Build for deployment..."
        gcloud builds submit \
          --config=cloudbuild.yaml \
          --substitutions=_REGION=${{ env.GCP_REGION }},_SERVICE_NAME=${{ env.SERVICE_NAME }},_CONFIG_BUCKET=gs://${{ env.CONFIG_BUCKET }} \
          --async
        
        echo "Cloud Build triggered successfully!"
        echo "View build logs at: https://console.cloud.google.com/cloud-build/builds?project=${{ env.GCP_PROJECT }}"

  # Job 4: Validação de segurança
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run cargo audit
      uses: actions-rs/audit-check@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check for secrets in code
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified
