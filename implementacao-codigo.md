# Implementa√ß√£o - C√≥digo Completo ChatGuru √ó ClickUp

## üöÄ Servidor Middleware (Node.js)

### Arquivo: `middleware/server.js`

```javascript
// Servidor Middleware - Integra√ß√£o ChatGuru x ClickUp
// Empresa: Nordja

require('dotenv').config();
const express = require('express');
const axios = require('axios');
const cors = require('cors');

const app = express();
const PORT = process.env.PORT || 3000;

// Configura√ß√µes
const CLICKUP_API_TOKEN = process.env.CLICKUP_API_TOKEN;
const CLICKUP_LIST_ID = process.env.CLICKUP_LIST_ID;
const MIDDLEWARE_TOKEN = process.env.MIDDLEWARE_TOKEN;

// Middlewares
app.use(express.json());
app.use(cors());

// Middleware de autentica√ß√£o
const authenticateRequest = (req, res, next) => {
  const token = req.headers.authorization?.replace('Bearer ', '');
  
  if (!token || token !== MIDDLEWARE_TOKEN) {
    return res.status(401).json({ 
      success: false, 
      error: 'Token de autentica√ß√£o inv√°lido' 
    });
  }
  
  next();
};

// Fun√ß√£o para mapear prioridade
const getPriorityValue = (prioridade) => {
  const priorities = {
    'Alta': 1,
    'M√©dia': 2, 
    'Baixa': 3,
    'Normal': 2
  };
  return priorities[prioridade] || 2;
};

// Fun√ß√£o para calcular data de vencimento
const calculateDueDate = (prazo) => {
  if (!prazo) return null;
  
  const hoje = new Date();
  let diasAdicionais = 7; // Default: 7 dias
  
  // Interpretar o prazo informado
  if (prazo.toLowerCase().includes('urgente') || prazo.toLowerCase().includes('hoje')) {
    diasAdicionais = 1;
  } else if (prazo.toLowerCase().includes('amanh√£')) {
    diasAdicionais = 2;
  } else if (prazo.toLowerCase().includes('semana')) {
    diasAdicionais = 7;
  } else if (prazo.toLowerCase().includes('m√™s')) {
    diasAdicionais = 30;
  }
  
  const dataVencimento = new Date(hoje.getTime() + (diasAdicionais * 24 * 60 * 60 * 1000));
  return dataVencimento.getTime();
};

// Fun√ß√£o principal para criar tarefa no ClickUp
async function createClickUpTask(pedidoData) {
  try {
    const payload = {
      name: `Pedido - ${pedidoData.cliente}`,
      description: `
**Cliente:** ${pedidoData.cliente}
**Descri√ß√£o:** ${pedidoData.descricao}
**Contato:** ${pedidoData.contato}
**Prazo Desejado:** ${pedidoData.prazo}
**Prioridade:** ${pedidoData.prioridade}
**Origem:** ChatGuru WhatsApp Bot
**Data/Hora:** ${new Date().toLocaleString('pt-BR')}

---
**Detalhes Adicionais:**
${pedidoData.observacoes || 'Nenhuma observa√ß√£o adicional'}
      `,
      assignees: [], // Ser√° definido pela equipe Nordja
      tags: ["pedido", "chatguru-bot", "whatsapp"],
      status: "Open",
      priority: getPriorityValue(pedidoData.prioridade),
      due_date: calculateDueDate(pedidoData.prazo),
      notify_all: true
    };

    console.log('üì§ Enviando para ClickUp:', {
      url: `https://api.clickup.com/api/v2/list/${CLICKUP_LIST_ID}/task`,
      cliente: pedidoData.cliente,
      prioridade: pedidoData.prioridade
    });

    const response = await axios.post(
      `https://api.clickup.com/api/v2/list/${CLICKUP_LIST_ID}/task`,
      payload,
      {
        headers: {
          'Authorization': `Bearer ${CLICKUP_API_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );

    console.log('‚úÖ Tarefa criada no ClickUp:', response.data.id);
    return response;

  } catch (error) {
    console.error('‚ùå Erro ao criar tarefa no ClickUp:', error.response?.data || error.message);
    throw new Error(`Erro na API do ClickUp: ${error.response?.data?.err || error.message}`);
  }
}

// Endpoint principal - Receber dados da ChatGuru e criar tarefa no ClickUp
app.post('/chatguru/create-task', authenticateRequest, async (req, res) => {
  try {
    console.log('üì• Dados recebidos da ChatGuru:', req.body);

    const { cliente, descricao, prioridade, prazo, contato, observacoes } = req.body;

    // Valida√ß√£o b√°sica
    if (!cliente || !descricao) {
      return res.status(400).json({
        success: false,
        error: 'Campos obrigat√≥rios: cliente e descri√ß√£o'
      });
    }

    // Criar tarefa no ClickUp
    const clickupResponse = await createClickUpTask({
      cliente: cliente.trim(),
      descricao: descricao.trim(),
      prioridade: prioridade || 'M√©dia',
      prazo: prazo || 'A definir',
      contato: contato || 'N√£o informado',
      observacoes: observacoes || ''
    });

    // Retornar sucesso para a ChatGuru
    res.json({
      success: true,
      taskId: clickupResponse.data.id,
      taskUrl: clickupResponse.data.url,
      message: 'Tarefa criada com sucesso!'
    });

  } catch (error) {
    console.error('üí• Erro no processamento:', error.message);
    
    res.status(500).json({
      success: false,
      error: 'Erro interno do servidor',
      details: error.message
    });
  }
});

// Endpoint de teste - Verificar se o servidor est√° funcionando
app.get('/health', (req, res) => {
  res.json({
    status: 'OK',
    timestamp: new Date().toISOString(),
    service: 'ChatGuru-ClickUp Integration',
    version: '1.0.0'
  });
});

// Endpoint de teste - Testar conex√£o com ClickUp
app.get('/test-clickup', authenticateRequest, async (req, res) => {
  try {
    const response = await axios.get(
      `https://api.clickup.com/api/v2/list/${CLICKUP_LIST_ID}`,
      {
        headers: {
          'Authorization': `Bearer ${CLICKUP_API_TOKEN}`
        }
      }
    );

    res.json({
      success: true,
      listName: response.data.name,
      listId: response.data.id,
      message: 'Conex√£o com ClickUp OK!'
    });

  } catch (error) {
    res.status(500).json({
      success: false,
      error: 'Erro ao conectar com ClickUp',
      details: error.response?.data || error.message
    });
  }
});

// Tratamento de erros global
app.use((error, req, res, next) => {
  console.error('üö® Erro n√£o tratado:', error);
  res.status(500).json({
    success: false,
    error: 'Erro interno do servidor'
  });
});

// Iniciar servidor
app.listen(PORT, () => {
  console.log(`üöÄ Servidor rodando na porta ${PORT}`);
  console.log(`üìã ClickUp List ID: ${CLICKUP_LIST_ID}`);
  console.log(`üîë Token configurado: ${CLICKUP_API_TOKEN ? 'Sim' : 'N√£o'}`);
});

module.exports = app;
```

### Arquivo: `middleware/package.json`

```json
{
  "name": "chatguru-clickup-integration",
  "version": "1.0.0",
  "description": "Integra√ß√£o entre ChatGuru e ClickUp para Nordja",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "test": "jest"
  },
  "dependencies": {
    "express": "^4.18.2",
    "axios": "^1.6.0",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1"
  },
  "devDependencies": {
    "nodemon": "^3.0.1",
    "jest": "^29.7.0"
  },
  "keywords": ["chatguru", "clickup", "integration", "chatbot"],
  "author": "Equipe Integra√ß√£o",
  "license": "MIT"
}
```

### Arquivo: `middleware/.env.example`

```bash
# Configura√ß√µes do ClickUp
CLICKUP_API_TOKEN=pk_your_clickup_token_here
CLICKUP_LIST_ID=your_list_id_here

# Configura√ß√µes do Middleware
MIDDLEWARE_TOKEN=your_secure_middleware_token
PORT=3000

# Configura√ß√µes opcionais
NODE_ENV=production
LOG_LEVEL=info
```

## üîß Scripts de Deploy

### Arquivo: `middleware/deploy.sh`

```bash
#!/bin/bash

# Script de Deploy - ChatGuru ClickUp Integration
echo "üöÄ Iniciando deploy da integra√ß√£o ChatGuru-ClickUp..."

# Verificar se .env existe
if [ ! -f .env ]; then
    echo "‚ùå Arquivo .env n√£o encontrado!"
    echo "Copie .env.example para .env e configure as vari√°veis"
    exit 1
fi

# Instalar depend√™ncias
echo "üì¶ Instalando depend√™ncias..."
npm install

# Executar testes
echo "üß™ Executando testes..."
npm test

# Verificar se testes passaram
if [ $? -eq 0 ]; then
    echo "‚úÖ Testes passaram!"
else
    echo "‚ùå Testes falharam! Deploy cancelado."
    exit 1
fi

# Iniciar aplica√ß√£o
echo "üéØ Iniciando aplica√ß√£o..."
pm2 restart chatguru-clickup-integration || pm2 start server.js --name chatguru-clickup-integration

echo "‚úÖ Deploy conclu√≠do com sucesso!"
echo "üåê Aplica√ß√£o dispon√≠vel em: http://localhost:3000"
echo "üè• Health check: http://localhost:3000/health"
```

## üß™ Testes

### Arquivo: `middleware/tests/integration.test.js`

```javascript
const request = require('supertest');
const app = require('../server');

describe('ChatGuru-ClickUp Integration Tests', () => {
  const validToken = process.env.MIDDLEWARE_TOKEN;

  test('Health check deve retornar status OK', async () => {
    const response = await request(app)
      .get('/health');
    
    expect(response.status).toBe(200);
    expect(response.body.status).toBe('OK');
  });

  test('Endpoint sem token deve retornar erro 401', async () => {
    const response = await request(app)
      .post('/chatguru/create-task')
      .send({
        cliente: 'Teste',
        descricao: 'Descri√ß√£o teste'
      });
    
    expect(response.status).toBe(401);
  });

  test('Endpoint com token v√°lido mas dados incompletos', async () => {
    const response = await request(app)
      .post('/chatguru/create-task')
      .set('Authorization', `Bearer ${validToken}`)
      .send({
        cliente: 'Teste'
        // faltando descri√ß√£o
      });
    
    expect(response.status).toBe(400);
    expect(response.body.success).toBe(false);
  });

  test('Teste de conex√£o ClickUp', async () => {
    const response = await request(app)
      .get('/test-clickup')
      .set('Authorization', `Bearer ${validToken}`);
    
    // Pode retornar 200 (OK) ou 500 (erro de configura√ß√£o)
    expect([200, 500]).toContain(response.status);
  });
});
```

## üìã Configura√ß√£o do Fluxo ChatGuru

### Estrutura do Flow no ChatGuru

#### 1. Gatilho PLN (Frases de Treino)

```
Frases para reconhecimento de pedidos:
- "Preciso fazer um pedido"
- "Quero solicitar um servi√ßo"
- "Gostaria de encomendar"
- "Preciso de um or√ßamento"
- "Quero fazer uma solicita√ß√£o"
- "Tenho uma demanda"
- "Preciso contratar"
- "Quero um projeto"
- "Gostaria de solicitar"
- "Tenho uma necessidade"
- "Preciso de ajuda com"
- "Quero contratar voc√™s"
```

#### 2. Sequ√™ncia do Fluxo

**Etapa 1: Confirma√ß√£o da Inten√ß√£o**
```
Mensagem: "Entendi que voc√™ quer fazer um pedido! üòä
Vou te ajudar a registrar sua solicita√ß√£o.
Vamos come√ßar?"

Bot√µes: [Sim, vamos l√°!] [Cancelar]
```

**Etapa 2: Captura do Nome**
```
Mensagem: "Primeiro, me diga seu nome completo:"
Vari√°vel: {{nome_cliente}}
Valida√ß√£o: Obrigat√≥rio, m√≠nimo 2 palavras
```

**Etapa 3: Captura da Descri√ß√£o**
```
Mensagem: "Agora me conte: o que voc√™ precisa?
Seja o mais detalhado poss√≠vel:"

Vari√°vel: {{descricao_pedido}}
Valida√ß√£o: Obrigat√≥rio, m√≠nimo 10 caracteres
```

**Etapa 4: Captura da Prioridade**
```
Mensagem: "Como voc√™ classificaria a urg√™ncia do seu pedido?"

Bot√µes: 
[üî¥ Alta] ‚Üí {{prioridade_selecionada}} = "Alta"
[üü° M√©dia] ‚Üí {{prioridade_selecionada}} = "M√©dia"  
[üü¢ Baixa] ‚Üí {{prioridade_selecionada}} = "Baixa"
```

**Etapa 5: Captura do Prazo**
```
Mensagem: "Qual o prazo desejado para este pedido?
(Ex: urgente, 1 semana, 1 m√™s)"

Vari√°vel: {{prazo_desejado}}
Valida√ß√£o: Opcional
```

**Etapa 6: Captura do Contato**
```
Mensagem: "Por √∫ltimo, confirme seu melhor contato:
(telefone, email ou WhatsApp)"

Vari√°vel: {{contato_cliente}}
Valida√ß√£o: Opcional
```

**Etapa 7: Confirma√ß√£o dos Dados**
```
Mensagem: "Vou confirmar os dados do seu pedido:

üë§ Nome: {{nome_cliente}}
üìù Descri√ß√£o: {{descricao_pedido}}
‚ö° Prioridade: {{prioridade_selecionada}}
‚è∞ Prazo: {{prazo_desejado}}
üìû Contato: {{contato_cliente}}

Est√° tudo correto?"

Bot√µes: [‚úÖ Confirmar] [‚ùå Corrigir]
```

#### 3. Requisi√ß√£o HTTP (Envio para ClickUp)

**URL do Endpoint:**
```
https://your-middleware-domain.com/chatguru/create-task
```

**M√©todo:**
```
POST
```

**Headers:**
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer YOUR_MIDDLEWARE_TOKEN"
}
```

**Body (JSON):**
```json
{
  "cliente": "{{nome_cliente}}",
  "descricao": "{{descricao_pedido}}",
  "prioridade": "{{prioridade_selecionada}}",
  "prazo": "{{prazo_desejado}}",
  "contato": "{{contato_cliente}}"
}
```

#### 4. Tratamento da Resposta

**Resposta de Sucesso (Status 200):**
```
Mensagem: "‚úÖ Pedido registrado com sucesso!

üìã ID da Tarefa: {{response.taskId}}
üîó Link: {{response.taskUrl}}

Nossa equipe recebeu sua solicita√ß√£o e entrar√° em contato em breve!

Obrigado pela prefer√™ncia! üòä"
```

**Resposta de Erro (Status != 200):**
```
Mensagem: "‚ùå Ops! Ocorreu um problema ao registrar seu pedido.

N√£o se preocupe, nossa equipe foi notificada. 
Por favor, tente novamente em alguns minutos ou entre em contato diretamente:

üìû Telefone: (XX) XXXX-XXXX
üìß Email: contato@nordja.com

Pedimos desculpas pelo inconveniente!"
```

## üîÑ Mapeamento de Dados

### Tabela de Correspond√™ncia ChatGuru ‚Üí ClickUp

| Campo ChatGuru | Campo ClickUp | Tipo | Obrigat√≥rio | Observa√ß√µes |
|------------|---------------|------|-------------|-------------|
| `{{nome_cliente}}` | `name` (prefixo "Pedido -") | String | Sim | T√≠tulo da tarefa |
| `{{descricao_pedido}}` | `description` | String | Sim | Descri√ß√£o principal |
| `{{prioridade_selecionada}}` | `priority` | Integer | N√£o | 1=Alta, 2=M√©dia, 3=Baixa |
| `{{prazo_desejado}}` | `due_date` | Timestamp | N√£o | Convertido para timestamp |
| `{{contato_cliente}}` | `description` (embed) | String | N√£o | Inclu√≠do na descri√ß√£o |
| - | `tags` | Array | N√£o | ["pedido", "chatguru-bot", "whatsapp"] |
| - | `status` | String | N√£o | "Open" (padr√£o) |
| - | `assignees` | Array | N√£o | Definido pela equipe Nordja |

### Regras de Convers√£o

**Prioridade:**
- "Alta" ‚Üí 1 (Urgent)
- "M√©dia" ‚Üí 2 (High) 
- "Baixa" ‚Üí 3 (Normal)
- Default ‚Üí 2 (High)

**Prazo (Due Date):**
- "urgente" / "hoje" ‚Üí +1 dia
- "amanh√£" ‚Üí +2 dias  
- "semana" ‚Üí +7 dias
- "m√™s" ‚Üí +30 dias
- Default ‚Üí +7 dias

## üöÄ Instru√ß√µes de Deploy

### 1. Prepara√ß√£o do Ambiente

```bash
# Clonar/criar diret√≥rio do projeto
mkdir chatguru-clickup-integration
cd chatguru-clickup-integration

# Criar estrutura de pastas
mkdir middleware tests docs

# Copiar arquivos do c√≥digo acima
# server.js, package.json, .env.example, etc.
```

### 2. Configura√ß√£o

```bash
# Instalar depend√™ncias
npm install

# Configurar vari√°veis de ambiente
cp .env.example .env
nano .env

# Configurar as vari√°veis:
# CLICKUP_API_TOKEN=pk_seu_token_aqui
# CLICKUP_LIST_ID=sua_lista_id
# MIDDLEWARE_TOKEN=token_seguro_middleware
```

### 3. Testes Locais

```bash
# Executar testes
npm test

# Iniciar servidor local
npm run dev

# Testar endpoints
curl http://localhost:3000/health
curl -H "Authorization: Bearer seu_token" http://localhost:3000/test-clickup
```

### 4. Deploy em Produ√ß√£o

```bash
# Usar PM2 para gerenciamento de processo
npm install -g pm2

# Iniciar aplica√ß√£o
pm2 start server.js --name chatguru-clickup-integration

# Configurar auto-restart
pm2 startup
pm2 save
```

### 5. Configura√ß√£o na ChatGuru

1. **Acessar o painel da ChatGuru**
2. **Criar novo Flow**
3. **Configurar gatilhos PLN** com as frases de treino
4. **Montar sequ√™ncia** de captura de dados
5. **Configurar requisi√ß√£o HTTP** com os par√¢metros acima
6. **Testar fluxo** com dados reais

---

**üéØ Status da Implementa√ß√£o:** C√≥digo completo e pronto para deploy
**üìã Pr√≥ximos Passos:** Configurar ambiente de produ√ß√£o e testar integra√ß√£o
**üë• Respons√°vel:** Equipe de Integra√ß√£o Nordja