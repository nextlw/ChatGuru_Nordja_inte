\n# üö® AN√ÅLISE DE DISCREP√ÇNCIAS: Webhook ChatGuru vs C√≥digo Rust\n\n## üìÖ Data da An√°lise\n**Data:** 23/09/2025  \n**Analista:** Elai  \n**Status:** ‚ö†Ô∏è **CR√çTICO - C√≥digo N√ÉO compat√≠vel com padr√£o esperado**\n\n## 1. RESUMO EXECUTIVO\n\nO c√≥digo Rust atual **N√ÉO est√° preparado** para receber o padr√£o de webhook do ChatGuru documentado. Existem discrep√¢ncias cr√≠ticas na estrutura de dados que causar√£o falhas na deserializa√ß√£o do JSON e perda de informa√ß√µes importantes.\n\n## 2. PADR√ÉO ESPERADO DO CHATGURU\n\n```json\n{\n  \"campanha_id\": \"ID da Campanha\",\n  \"campanha_nome\": \"Nome da Campanha\",\n  \"origem\": \"ChatGuru\",\n  \"email\": \"556292650123@c.us\",\n  \"nome\": \"Nome do seu Lead\",\n  \"tags\": [\n    \"ü§ñ Zap.Guru\",\n    \"‚úÖ Fechado e Ganho\",\n    \"Origem: Instagram\"\n  ],\n  \"texto_mensagem\": \"Texto da mensagem que executou o gatilho para o post\",\n  \"campos_personalizados\": {\n    \"email2\": \"cliente@mail.com\",\n    \"Site\": \"https://www.empresa.com\",\n    \"Valor\": \"1567.87\",\n    \"CNPJ\": \"24.111.111/0001-01\",\n    \"Empresa\": \"EMPRESA S.A\"\n  },\n  \"bot_context\": {\n    \"ChatGuru\": true\n  },\n  \"responsavel_nome\": \"\",\n  \"responsavel_email\": \"\",\n  \"link_chat\": \"https://app2.zap.guru/chats/5e370c9334a812e7e183f760\",\n  \"celular\": \"556212650015\"\n}\n```\n\n## 3. ESTRUTURA ATUAL NO RUST\n\n### 3.1 Arquivo: `src/models/chatguru_events.rs`\n\n```rust\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct ChatGuruEvent {\n    #[serde(rename = \"event_id\")]\n    pub id: Option<String>,\n    pub event_type: String,\n    pub timestamp: String,\n    \n    #[serde(default = \"default_value\")]\n    pub data: Value,\n    \n    pub source: Option<String>,\n    pub metadata: Option<Value>,\n    \n    // Campos espec√≠ficos do ChatGuru\n    pub account_id: Option<String>,\n    pub phone_id: Option<String>,\n    pub contact: Option<Value>,\n    pub annotation: Option<Value>,\n}\n```\n\n## 4. TABELA DE DISCREP√ÇNCIAS\n\n### 4.1 Campos Faltantes (N√ÉO existem no c√≥digo Rust)\n\n| Campo JSON | Tipo | Obrigat√≥rio | Descri√ß√£o | Impacto |\n|------------|------|-------------|-----------|---------|\n| `campanha_id` | String | Sim | ID da Campanha | **CR√çTICO** - N√£o ser√° capturado |\n| `campanha_nome` | String | Sim | Nome da Campanha | **CR√çTICO** - N√£o ser√° capturado |\n| `origem` | String | Sim | Sempre \"ChatGuru\" | **ALTO** - Perda de rastreabilidade |\n| `nome` | String | Sim | Nome do Lead | **CR√çTICO** - Dados do cliente perdidos |\n| `email` | String | Sim | Email/WhatsApp ID | **CR√çTICO** - Contato perdido |\n| `texto_mensagem` | String | Sim | Mensagem do gatilho | **CR√çTICO** - Contexto perdido |\n| `campos_personalizados` | Object | N√£o | Dados da empresa | **ALTO** - Dados comerciais perdidos |\n| `tags` | Array | Sim | Tags do lead | **M√âDIO** - Categoriza√ß√£o perdida |\n| `responsavel_nome` | String | N√£o | Nome do respons√°vel | **BAIXO** |\n| `responsavel_email` | String | N√£o | Email do respons√°vel | **BAIXO** |\n| `link_chat` | String | Sim | Link direto do chat | **ALTO** - Rastreabilidade perdida |\n| `celular` | String | Sim | N√∫mero do celular | **CR√çTICO** - Contato perdido |\n\n### 4.2 Incompatibilidade Estrutural\n\n| Aspecto | Esperado | Atual | Problema |\n|---------|----------|-------|----------|\n| **Estrutura** | Campos diretos no root | Campos em `data` ou `annotation` | Incompat√≠vel |\n| **Nomenclatura** | Portugu√™s (campos_personalizados) | Ingl√™s (custom_fields) | N√£o mapear√° |\n| **Tipo de evento** | N√£o especificado no payload | Requer `event_type` | Faltar√° campo obrigat√≥rio |\n| **Timestamp** | N√£o existe no payload | Requer `timestamp` | Faltar√° campo obrigat√≥rio |\n\n## 5. AN√ÅLISE DO PROCESSAMENTO (`src/handlers/webhook.rs`)\n\n### 5.1 Problemas na Deserializa√ß√£o\n\n```rust\n// Linha 38-39 - FALHAR√Å na deserializa√ß√£o\nlet chatguru_event: ChatGuruEvent = serde_json::from_str(&body_str)\n    .map_err(|e| AppError::ValidationError(format!(\"Invalid JSON payload: {}\", e)))?;\n```\n\n**PROBLEMA:** O JSON recebido n√£o tem os campos esperados pela struct `ChatGuruEvent`.\n\n### 5.2 Problemas na Valida√ß√£o\n\n```rust\n// Linha 162-164 - FALHAR√Å pois n√£o existe event_type\nif event.event_type.is_empty() {\n    return Err(AppError::ValidationError(\"Event type cannot be empty\".to_string()));\n}\n\n// Linha 170-173 - FALHAR√Å pois n√£o existe timestamp\nif event.timestamp.is_empty() {\n    return Err(AppError::ValidationError(\"Timestamp cannot be empty\".to_string()));\n}\n```\n\n## 6. AN√ÅLISE DO SERVI√áO CLICKUP (`src/services/clickup.rs`)\n\n### 6.1 Mapeamento Incorreto\n\nO c√≥digo atual espera dados em `event.data` mas o webhook enviar√° campos diretos:\n\n```rust\n// Linha 149-154 - N√ÉO encontrar√° os campos\nif let Some(task_title) = event.data.get(\"task_title\")\n    .or_else(|| event.data.get(\"annotation\"))\n    .or_else(|| event.data.get(\"anotacao\"))\n    .and_then(|v| v.as_str()) {\n    return task_title.to_string();\n}\n```\n\n### 6.2 Perda de Informa√ß√µes Cr√≠ticas\n\nInforma√ß√µes importantes n√£o ser√£o capturadas:\n- Link direto para o chat (`link_chat`)\n- Dados da campanha (`campanha_id`, `campanha_nome`)\n- Campos personalizados da empresa (CNPJ, Valor, Site)\n\n## 7. CORRE√á√ïES NECESS√ÅRIAS\n\n### 7.1 Nova Estrutura de Dados\n\n```rust\n// Criar novo arquivo: src/models/chatguru_webhook.rs\n\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\n#[derive(Debug, Deserialize, Serialize, Clone)]\npub struct ChatGuruWebhookPayload {\n    pub campanha_id: String,\n    pub campanha_nome: String,\n    pub origem: String,\n    pub email: String,\n    pub nome: String,\n    pub tags: Vec<String>,\n    pub texto_mensagem: String,\n    pub campos_personalizados: Option<HashMap<String, String>>,\n    pub bot_context: Option<HashMap<String, serde_json::Value>>,\n    pub responsavel_nome: Option<String>,\n    pub responsavel_email: Option<String>,\n    pub link_chat: String,\n    pub celular: String,\n}\n```\n\n### 7.2 Atualizar Handler\n\n```rust\n// src/handlers/webhook.rs - Nova vers√£o\n\npub async fn handle_chatguru_webhook(\n    State(state): State<Arc<AppState>>,\n    headers: HeaderMap,\n    request: Request<Body>,\n) -> Result<Json<Value>, AppError> {\n    // ... c√≥digo de extra√ß√£o do body ...\n\n    // Deserializar para a nova estrutura\n    let webhook_payload: ChatGuruWebhookPayload = serde_json::from_str(&body_str)\n        .map_err(|e| AppError::ValidationError(format!(\"Invalid webhook payload: {}\", e)))?;\n\n    // Converter para formato interno se necess√°rio\n    let event = convert_webhook_to_event(webhook_payload);\n\n    // Processar...\n}\n```\n\n### 7.3 Fun√ß√£o de Convers√£o\n\n```rust\nfn convert_webhook_to_event(payload: ChatGuruWebhookPayload) -> ChatGuruEvent {\n    let mut data = json!({\n        \"nome\": payload.nome,\n        \"email\": payload.email,\n        \"celular\": payload.celular,\n        \"texto_mensagem\": payload.texto_mensagem,\n        \"campanha_id\": payload.campanha_id,\n        \"campanha_nome\": payload.campanha_nome,\n        \"link_chat\": payload.link_chat,\n        \"tags\": payload.tags,\n    });\n\n    // Adicionar campos personalizados\n    if let Some(campos) = payload.campos_personalizados {\n        data[\"campos_personalizados\"] = json!(campos);\n    }\n\n    ChatGuruEvent {\n        id: Some(format!(\"webhook_{}\", chrono::Utc::now().timestamp_millis())),\n        event_type: \"webhook_chatguru\".to_string(),\n        timestamp: chrono::Utc::now().to_rfc3339(),\n        data,\n        source: Some(payload.origem),\n        metadata: paylo